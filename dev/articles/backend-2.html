<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dplyr 2.0.0 transition guide • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../.css" rel="stylesheet">
<meta property="og:title" content="dplyr 2.0.0 transition guide">
<meta property="og:description" content="dbplyr">
<meta property="og:image" content="https://dbplyr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dbplyr</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.99.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/dbplyr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/backend-2.html">dplyr 2.0.0 transition guide</a>
    </li>
    <li>
      <a href="../articles/new-backend.html">Adding a new DBI backend</a>
    </li>
    <li>
      <a href="../articles/reprex.html">Reprexes for dbplyr</a>
    </li>
    <li>
      <a href="../articles/sql.html">Writing SQL with dbplyr</a>
    </li>
    <li>
      <a href="../articles/translation-function.html">Function translation</a>
    </li>
    <li>
      <a href="../articles/translation-verb.html">Verb translation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/tidyverse/dbplyr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="backend-2_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>dplyr 2.0.0 transition guide</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/master/vignettes/backend-2.Rmd"><code>vignettes/backend-2.Rmd</code></a></small>
      <div class="hidden name"><code>backend-2.Rmd</code></div>

    </div>

    
    
<p>This transition guide is aimed at backend authors. One of the big goals of dbplyr 2.0.0 is to ensure that all dbplyr generics can live in dplyr. I’ve done my best to design than transition so you can write a backend that works with both dbplyr 1.0.0 and dbplyr 2.0.0, and the complete transition won’t happen immediately but will play out over the next year or two.</p>
<p>(dbplyr 2.0.0 won’t be released for at least 3 months after I notify all backend authors, and if you need more time I’m happy to extend this deadline.)</p>
<p>The basic idea is that no generics will “move”; instead dbplyr will add new generics and dplyr will eventually remove them. This makes it straightforward to support both dbplyr 1.0.0 and 2.0.0 in a single package.</p>
<div id="dbi-generics" class="section level2">
<h2 class="hasAnchor">
<a href="#dbi-generics" class="anchor"></a>DBI generics</h2>
<p>When dbplyr was first created there was much spurious variation across DBI backends, and a layer of shims was need to make dbplyr usable. Now thanks to the work of Kiril Muller and on others on DBITest and friends, these shims are no longer needed, and dbplyr will now call the DBI generics directly:</p>
<ul>
<li>Transaction management (using inside <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code> to make indexing as efficient as possible): <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_begin()</a></code> -&gt; <code>dbBegin()</code>, <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_commit()</a></code> -&gt; <code>dbCommit()</code>, and <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_rollback()</a></code> -&gt; <code>dbRollback()</code>
</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code> now uses <code>dbWriteTable()</code> instead of <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_write_table()</a></code>. This also eliminates this eliminates <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_create_table()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_insert_into()</a></code>, and <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_data_type()</a></code> that were used for initial creation, and <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_list_tables()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_has_table()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">db_drop_table()</a></code> used to support overwriting existing tables.</li>
<li>Escaping now uses the DBI generics: <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_escape_ident()</a></code> is replaced by <code>dbQuoteIdentifer()</code> and <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_escape_string()</a></code> is replaced by <code>dbQuoteString()</code>. (These two generics still exist inside of dplyr but are used purely for testing).</li>
</ul>
<p>If you have provided methods any of these dbplyr generics you’ll need to:</p>
<ul>
<li>Implement a method for the corresponding DBI generic: this ensures that your package will work with dbplyr 2.0.0.</li>
</ul>
<!-- --><ul>
<li>Call the DBI generic from the existing dbplyr method. Don’t delete your existing methods or your package will no longer work with dbplyr 1.0.0.</li>
</ul>
<p>I <em>think</em> that this should cause relatively little pain because DBI support is now much better than it used to be and most backend authors provide both the dbplyr and DBI interfaces. Even if there is some pain, I think it’s relatively worthwhile pain as it helps out everyone, not just dbplyr users.</p>
</div>
<div id="sql-generation" class="section level2">
<h2 class="hasAnchor">
<a href="#sql-generation" class="anchor"></a>SQL generation</h2>
<p>There are a number of dplyr generics that basically generate SQL and then execute it. Now rather than implementation method for a <code>db_*</code> generic from dplyr, you can implement a method for a <code>sql_*</code> generic from dbplyr.</p>
<p>If you have any of the following generics, extract the SQL generation code into a new <code>sql_</code> method:</p>
<pre><code>db_create_index   -&gt; sql_index_create
db_analyze        -&gt; sql_table_analyze
db_query_rows     -&gt; sql_query_rows
db_save_query     -&gt; sql_query_save
db_query_fields   -&gt; sql_query_fields
db_explain        -&gt; sql_query_explain</code></pre>
<p>Again, you’ll need to keep your old <code>db_</code> method (so your package continues to work with dbplyr 1.0.0), but you may want to use your new <code>sql_</code> method from it to avoid code duplication.</p>
<p>Eventually, dbplyr will stop calling the <code>db_</code> generic and will call the <code>sql_</code> generics directly.</p>
</div>
<div id="renamed-generics" class="section level2">
<h2 class="hasAnchor">
<a href="#renamed-generics" class="anchor"></a>Renamed generics</h2>
</div>
<div id="conditional-method-registration" class="section level2">
<h2 class="hasAnchor">
<a href="#conditional-method-registration" class="anchor"></a>Conditional method registration</h2>
<p>To make it possible to release your package to CRAN before dbplyr 2.0.0 is out (providing the best experience for your users), you can rely on the usual <code>@export</code> roxygen tag or <code>S3method()</code> <code>NAMESPACE</code> directive because that requires importing the generic (which won’t be available until after dbplyr 2.0.0 is available).</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">.onLoad</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">...</span>) {
  <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span>(<span class="st">"dbplyr"</span> <span class="op">&gt;=</span> <span class="st">"1.99"</span>)) {
    <span class="fu">s3_register</span>(<span class="st">"dbplyr::sql_index_create"</span>, <span class="st">"backend_class"</span>)
    <span class="fu">s3_register</span>(<span class="st">"dbplyr::sql_table_analyze"</span>, <span class="st">"backend_class"</span>)
  }
}

<span class="kw">s3_register</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">generic</span>, <span class="kw">class</span>, <span class="kw">method</span> = <span class="kw">NULL</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span>(<span class="kw">generic</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">generic</span>) <span class="op">==</span> <span class="fl">1</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span>(<span class="kw">class</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">class</span>) <span class="op">==</span> <span class="fl">1</span>)

  <span class="kw">pieces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="kw">generic</span>, <span class="st">"::"</span>)[[<span class="fl">1</span>]]
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">pieces</span>) <span class="op">==</span> <span class="fl">2</span>)
  <span class="kw">package</span> <span class="op">&lt;-</span> <span class="kw">pieces</span>[[<span class="fl">1</span>]]
  <span class="kw">generic</span> <span class="op">&lt;-</span> <span class="kw">pieces</span>[[<span class="fl">2</span>]]

  <span class="kw">caller</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>()

  <span class="kw">get_method_env</span> <span class="op">&lt;-</span> <span class="fu">function</span>() {
    <span class="kw">top</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-topenv.html">topenv</a></span>(<span class="kw">caller</span>)
    <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">isNamespace</a></span>(<span class="kw">top</span>)) {
      <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">asNamespace</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/environment.html">environmentName</a></span>(<span class="kw">top</span>))
    } <span class="co">else</span> {
      <span class="kw">caller</span>
    }
  }
  <span class="kw">get_method</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">method</span>, <span class="kw">env</span>) {
    <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">method</span>)) {
      <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">generic</span>, <span class="st">"."</span>, <span class="kw">class</span>), envir = <span class="fu">get_method_env</span>())
    } <span class="co">else</span> {
      <span class="kw">method</span>
    }
  }

  <span class="kw">method_fn</span> <span class="op">&lt;-</span> <span class="fu">get_method</span>(<span class="kw">method</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/is.function.html">is.function</a></span>(<span class="kw">method_fn</span>))

  <span class="co"># Always register hook in case package is later unloaded &amp; reloaded</span>
  <span class="fu"><a href="https://rdrr.io/r/base/userhooks.html">setHook</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/userhooks.html">packageEvent</a></span>(<span class="kw">package</span>, <span class="st">"onLoad"</span>),
    <span class="fu">function</span>(<span class="kw">...</span>) {
      <span class="kw">ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">asNamespace</a></span>(<span class="kw">package</span>)

      <span class="co"># Refresh the method, it might have been updated by `devtools::load_all()`</span>
      <span class="kw">method_fn</span> <span class="op">&lt;-</span> <span class="fu">get_method</span>(<span class="kw">method</span>)

      <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">registerS3method</a></span>(<span class="kw">generic</span>, <span class="kw">class</span>, <span class="kw">method_fn</span>, envir = <span class="kw">ns</span>)
    }
  )

  <span class="co"># Avoid registration failures during loading (pkgload or regular)</span>
  <span class="co">if</span> (<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">isNamespaceLoaded</a></span>(<span class="kw">package</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>())
  }

  <span class="kw">envir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">asNamespace</a></span>(<span class="kw">package</span>)

  <span class="co"># Only register if generic can be accessed</span>
  <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="kw">generic</span>, <span class="kw">envir</span>)) {
    <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html">registerS3method</a></span>(<span class="kw">generic</span>, <span class="kw">class</span>, <span class="kw">method_fn</span>, envir = <span class="kw">envir</span>)
  }

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>()
}
</pre></div>
<p>(<code>s3_register()</code> is licensed with <a href="https://choosealicense.com/licenses/unlicense/">the unlicense</a> so you’re free to copy and paste into your package, and there’s no need to acknowledge the contribution. Learn more about it at <code><a href="https://vctrs.r-lib.org/reference/s3_register.html">?vctrs::s3_register</a></code>.)</p>
<p>At some point in the future, you can formally require version 2.0.0 of dbplyr in your <code>DESCRIPTION</code>, and then delete this code, switching back to your usual way of exporting methods.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>dbplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Edgar Ruiz, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
